<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Undangan - Ucapan & Kehadiran</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Beberapa style kecil untuk balasan dan bubble */
    .comment-bubble { background: rgba(255,240,245,0.9); padding: 12px; border-radius: 12px; position: relative; }
    .comment-actions { position: absolute; right: 10px; top: 8px; display:flex; gap:6px; }
    .reply-bubble { background: rgba(250,250,250,0.9); padding:8px; border-radius:10px; margin-top:8px; margin-left:10px; border-left:3px solid #f9a8d4; }
    .heart { background: transparent; border: none; cursor: pointer; font-weight:600; }
    .reply { background: transparent; border: none; cursor: pointer; }
    .comment-author { font-weight:700; margin-bottom:6px; }
    .comment-msg { margin-bottom:6px; white-space:pre-wrap; }
    .comment-time { font-size:12px; color:#6b7280; }
  </style>
</head>
<body class="bg-gradient-to-b from-pink-50 to-white min-h-screen">

  <header class="py-8 text-center">
    <h1 class="font-dancing text-5xl text-pink-600">Undangan</h1>
    <p class="text-gray-600 mt-2">Kirim ucapan & konfirmasi kehadiran</p>
    <div class="mt-2 text-sm text-gray-500">Kepada: <span id="recipientName" class="font-semibold">Tamu Istimewa</span></div>
  </header>

  <!-- Ucapan & Kehadiran -->
  <section class="py-12 px-4 bg-white/60">
    <div class="max-w-4xl mx-auto">
      <h2 class="font-dancing text-4xl text-center text-pink-600 mb-8">Ucapan & Kehadiran</h2>

      <!-- Form -->
      <form id="commentForm" class="bg-white/80 p-6 rounded-2xl shadow mb-6">
        <input id="userName" placeholder="Nama Anda" class="w-full mb-3 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-pink-500" />
        <div class="mb-3 text-sm">
          <label class="mr-4"><input type="radio" name="attendance" value="insyaAllah Hadir" checked> ‚úîÔ∏è insyaAllah Hadir</label><br>
          <label><input type="radio" name="attendance" value="Maaf belum bisa hadir"> ‚ùå Maaf belum bisa hadir</label>
        </div>
        <textarea id="userMessage" rows="3" placeholder="Tuliskan ucapan & doa..." class="w-full mb-3 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-pink-500"></textarea>
        <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white py-3 rounded-lg shadow hover:scale-105 transition">Kirim</button>
      </form>

      <!-- Daftar komentar -->
      <div id="commentList" class="space-y-3 max-h-96 overflow-y-auto text-sm text-gray-800">
        <p class="text-gray-500 text-center">Memuat ucapan...</p>
      </div>
    </div>
  </section>

  <footer class="text-center py-8 text-xs text-gray-500">Data tersimpan di Firebase Realtime Database (public)</footer>

<script>
/*
  Versi Firebase via REST API
  - Ganti DB_URL jika perlu (atau biarkan sesuai yang Anda minta)
  - Rules yang Anda berikan: { "rules": { ".read": true, ".write": true } }
*/

const DB_URL = 'https://komentardb-default-rtdb.asia-southeast1.firebasedatabase.app'; // tanpa .json

// Utility: format waktu lokal ID
function formatNow(){
  const now=new Date();
  const t = now.toLocaleDateString('id-ID').split('.').reverse().join('/') + ', ' + now.toLocaleTimeString('id-ID');
  return { display: t, ts: now.getTime() };
}

// Ambil semua komentar dari Firebase (GET /comments.json)
async function getComments(){
  try {
    const res = await fetch(`${DB_URL}/comments.json`);
    if(!res.ok) throw new Error('Gagal mengambil data');
    const data = await res.json();
    if(!data) return [];
    // data is object of { key: commentObj }
    const arr = Object.keys(data).map(k => {
      const item = data[k];
      // ensure replies is array
      item.replies = item.replies || [];
      return { key: k, ...item };
    });
    // sort by timestamp descending (ts), fallback to key
    arr.sort((a,b)=> (b.ts || 0) - (a.ts || 0));
    return arr;
  } catch (e) {
    console.error('getComments error', e);
    return [];
  }
}

// Tambah komentar (POST /comments.json)
async function addComment(payload){
  // payload harus berisi: name, msg, attendance, likes, time, ts, replies
  try {
    const res = await fetch(`${DB_URL}/comments.json`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('Gagal menyimpan');
    const r = await res.json(); // {name: "-Mabc..."} key
    return r.name;
  } catch(e){
    console.error('addComment', e);
    throw e;
  }
}

// Update (PATCH) comment by key
async function patchComment(key, patchObj){
  try {
    const res = await fetch(`${DB_URL}/comments/${key}.json`, {
      method: 'PATCH',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(patchObj)
    });
    if(!res.ok) throw new Error('Gagal update');
    return await res.json();
  } catch(e){
    console.error('patchComment', e);
    throw e;
  }
}

// Replace entire comment (PUT)
async function putComment(key, obj){
  try {
    const res = await fetch(`${DB_URL}/comments/${key}.json`, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(obj)
    });
    if(!res.ok) throw new Error('Gagal put');
    return await res.json();
  } catch(e){
    console.error('putComment', e);
    throw e;
  }
}

// Delete comment (DELETE)
async function deleteCommentByKey(key){
  try {
    const res = await fetch(`${DB_URL}/comments/${key}.json`, {
      method: 'DELETE'
    });
    if(!res.ok) throw new Error('Gagal hapus');
    return true;
  } catch(e){
    console.error('deleteCommentByKey', e);
    throw e;
  }
}

/* --- UI / Render --- */

const form = document.getElementById('commentForm');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('userName').value.trim();
  const msg = document.getElementById('userMessage').value.trim();
  const attendance = document.querySelector('input[name="attendance"]:checked').value;
  if(!name || !msg){ alert('Isi nama dan ucapan ya üíï'); return; }

  const symbol = attendance === 'insyaAllah Hadir' ? '‚úîÔ∏è insyaAllah Hadir' : '‚ùå Maaf belum bisa hadir';
  const now = formatNow();
  const payload = {
    name,
    msg,
    attendance: symbol,
    likes: 0,
    time: now.display,
    ts: now.ts,
    replies: []
  };

  try {
    // disable button sementara
    const btn = form.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Menyimpan...';
    await addComment(payload);
    form.reset();
    await renderComments();
  } catch (err){
    alert('Gagal menyimpan ucapan. Silakan coba lagi.');
  } finally {
    const btn = form.querySelector('button[type="submit"]');
    btn.disabled = false;
    btn.textContent = 'Kirim';
  }
});

async function renderComments(){
  const list = document.getElementById('commentList');
  list.innerHTML = '<p class="text-gray-500 text-center">Memuat ucapan...</p>';
  const arr = await getComments();
  if(arr.length === 0){
    list.innerHTML = '<p class="text-gray-500 text-center">Belum ada ucapan üòç</p>';
    return;
  }
  list.innerHTML = arr.map(c => {
    const repliesHTML = (c.replies || []).map((r, ri) => `
      <div class="reply-bubble" id="reply-${c.key}-${ri}">
        <div class="flex justify-between items-start">
          <div>
            <div class="text-sm font-semibold">${escapeHtml(r.name || '')}</div>
            <div class="text-sm">${escapeHtml(r.msg || '')}</div>
            <div class="text-xs text-gray-500 mt-1">${escapeHtml(r.time || '')}</div>
          </div>
          <div class="flex flex-col items-end gap-1">
            <button class="heart" onclick="likeReply('${c.key}', ${ri})">‚ù§Ô∏è ${r.likes||0}</button>
            <button onclick="editReply('${c.key}', ${ri})">‚úèÔ∏è</button>
            <button onclick="deleteReply('${c.key}', ${ri})">üóëÔ∏è</button>
          </div>
        </div>
      </div>
    `).join('');

    return `
      <div class="comment-bubble" id="comment-${c.key}">
        <div class="comment-actions">
          <button class="heart" onclick="likeComment('${c.key}')">‚ù§Ô∏è ${c.likes||0}</button>
          <button onclick="editComment('${c.key}')">‚úèÔ∏è</button>
          <button onclick="deleteComment('${c.key}')">üóëÔ∏è</button>
          <button class="reply" onclick="replyComment('${c.key}')">‚Ü©Ô∏è</button>
        </div>
        <div class="comment-author">
          ${escapeHtml(c.name || '')}
          ${c.attendance && c.attendance.includes('‚úîÔ∏è') ? '<span class="text-green-600 font-semibold ml-2">‚úîÔ∏è</span>' : '<span class="text-red-600 font-semibold ml-2">‚ùå</span>'}
        </div>
        <div class="comment-msg">${escapeHtml(c.msg || '')}</div>
        <div class="comment-time">${escapeHtml(c.time || '')}</div>
        ${repliesHTML}
      </div>
    `;
  }).join('');
}

/* --- Actions: like, edit, delete, reply for comments & replies --- */

// Like comment
async function likeComment(key){
  try {
    // ambil object lalu +1 likes
    const comments = await getComments();
    const c = comments.find(x=>x.key===key);
    const newLikes = (c.likes||0) + 1;
    await patchComment(key, { likes: newLikes });
    await renderComments();
  } catch(e){
    alert('Gagal menambah like');
  }
}

// Edit comment
async function editComment(key){
  try {
    const comments = await getComments();
    const c = comments.find(x=>x.key===key);
    if(!c) return;
    const n = prompt('Edit ucapan:', c.msg);
    if(n && n.trim() !== ''){
      await patchComment(key, { msg: n });
      await renderComments();
    }
  } catch(e){
    alert('Gagal edit ucapan');
  }
}

// Delete comment
async function deleteComment(key){
  if(!confirm('Yakin hapus ucapan ini?')) return;
  try {
    await deleteCommentByKey(key);
    await renderComments();
  } catch(e){
    alert('Gagal menghapus ucapan');
  }
}

/* --- Reply functions (we store replies as array inside comment) --- */

// Reply to comment: prompt nama & pesan, push ke replies array, patch
async function replyComment(key){
  try {
    const rName = prompt('Nama Anda untuk balasan:');
    if(!rName || rName.trim()==='') return;
    const rMsg = prompt('Balas ucapan:');
    if(!rMsg || rMsg.trim()==='') return;
    const now = formatNow();
    // ambil comment
    const comments = await getComments();
    const c = comments.find(x=>x.key===key);
    if(!c) return;
    const replies = c.replies || [];
    replies.push({ name: rName, msg: rMsg, time: now.display, likes: 0 });
    await patchComment(key, { replies });
    await renderComments();
  } catch(e){
    alert('Gagal mengirim balasan');
  }
}

// Like reply
async function likeReply(key, ri){
  try {
    const comments = await getComments();
    const c = comments.find(x=>x.key===key);
    if(!c) return;
    c.replies = c.replies || [];
    c.replies[ri].likes = (c.replies[ri].likes||0) + 1;
    await patchComment(key, { replies: c.replies });
    await renderComments();
  } catch(e){
    alert('Gagal menambah like balasan');
  }
}

// Edit reply
async function editReply(key, ri){
  try {
    const comments = await getComments();
    const c = comments.find(x=>x.key===key);
    if(!c) return;
    const r = c.replies[ri];
    const n = prompt('Edit balasan:', r.msg);
    if(n && n.trim()!==''){
      c.replies[ri].msg = n;
      await patchComment(key, { replies: c.replies });
      await renderComments();
    }
  } catch(e){
    alert('Gagal edit balasan');
  }
}

// Delete reply
async function deleteReply(key, ri){
  if(!confirm('Yakin hapus balasan ini?')) return;
  try {
    const comments = await getComments();
    const c = comments.find(x=>x.key===key);
    if(!c) return;
    c.replies = c.replies || [];
    c.replies.splice(ri,1);
    await patchComment(key, { replies: c.replies });
    await renderComments();
  } catch(e){
    alert('Gagal hapus balasan');
  }
}

/* --- Helper: escape HTML untuk menghindari XSS sederhana --- */
function escapeHtml(unsafe) {
  if(unsafe === null || unsafe === undefined) return '';
  return String(unsafe)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

/* --- Init on load --- */
window.addEventListener('DOMContentLoaded', async () => {
  // render comments awal
  await renderComments();

  // jika ada param ?to=Nama, set recipientName
  const p = new URLSearchParams(window.location.search).get('to');
  if(p) document.getElementById('recipientName').textContent = decodeURIComponent(p);
});

// Expose functions to window so inline onclick can call them
window.likeComment = likeComment;
window.editComment = editComment;
window.deleteComment = deleteComment;
window.replyComment = replyComment;
window.likeReply = likeReply;
window.editReply = editReply;
window.deleteReply = deleteReply;
</script>
</body>
</html>
